#!/user/usr/bin/env python

import RPi.GPIO as GPIO
from mfrc522 import SimpleMFRC522
import time
import requests
DEVICE = "rasp"
VARIABLE1 = "status"
VARIABLE2 = "botao"
i=0
GPIO.setmode(GPIO.BCM)
GPIO.setup(24, GPIO.OUT)
GPIO.setup(21, GPIO.OUT)
reader = SimpleMFRC522()
GPIO.output(24, GPIO.LOW)
GPIO.output(21, GPIO.LOW)
TOKEN = "BBFF-EZAX7fhmDovbIvEQDDtDTew20piGPh"

while botao == 0:
botao  = requests.get("http://things.ubidots.com/api/v1.6/devices/rasp",headers = {"X-Auth-Token": TOKEN,"Content-Type": "application/json"},json = {VARIABLE2})
try:
 text = input('Insira o ID: ')
 print("Aproxime a TAG")
 reader.write(text)
 print("Cadastrado!")

 while True:
  id, dados = reader.read()
  dados = dados[:len(text)]
  print('dados:', dados)
  print('text:', text) 
  if text == dados:
   print('Acesso Liberado')
   i=0
   GPIO.output(24, GPIO.HIGH)
   dados  = requests.post("http://things.ubidots.com/api/v1.6/devices/rasp",headers = {"X-Auth-Token": TOKEN,"Content-Type": "application/json"},json = {VARIABLE1: 1})
   print(dados.text)
   time.sleep(4)
   GPIO.output(24, GPIO.LOW)
   dados  = requests.post("http://things.ubidots.com/api/v1.6/devices/Rasp",headers = {"X-Auth-Token": TOKEN,"Content-Type": "application/json"},json = {VARIABLE1: 0})
   time.sleep(5)
  else:       
     
	if i == 3:
        print('Alarme Ativado')
        GPIO.output(21, GPIO.HIGH)
        time.sleep(3)
        GPIO.output(21, GPIO.LOW)
        time.sleep(3)
        GPIO.output(21, GPIO.HIGH)
        time.sleep(3)
        GPIO.output(21, GPIO.LOW)
        time.sleep(3)
  else:
       print('Acesso Negado!')
       print('Aproxime a TAG Novamente')
       i=i+1

finally:
 GPIO.cleanup()